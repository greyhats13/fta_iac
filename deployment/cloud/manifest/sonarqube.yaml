deploymentType: "StatefulSet"
replicaCount: 1
revisionHistoryLimit: 10
edition: "community"
image:
  repository: sonarqube
  tag: 10.6.0-{{ .Values.edition }}
  pullPolicy: IfNotPresent
securityContext:
  fsGroup: 0
containerSecurityContext:
# Sonarqube dockerfile creates sonarqube user as UID and GID 0
  allowPrivilegeEscalation: false
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 0
  seccompProfile:
    type: RuntimeDefault
  capabilities:
    drop: ["ALL"]
service:
  type: ClusterIP
  externalPort: 9000
  internalPort: 9000

ingress:
  enabled: true
  hosts:
    - name: "${feature}.${dns_name}"
      path: /
      pathType: ImplementationSpecific
  annotations:
    # kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/proxy-body-size: "64m"
    kubernetes.io/tls-acme: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-${unit}"
    external-dns.alpha.kubernetes.io/hostname: "${feature}.${dns_name}"
  ingressClassName: nginx
  tls:
    - secretName: ${feature}-tls
      hosts:
        - "${feature}.${dns_name}"
nodeSelector:
  iam.gke.io/gke-metadata-server-enabled: "true"

initSysctl:
  enabled: true
  vmMaxMapCount: 524288
  fsFileMax: 131072
  nofile: 131072
  nproc: 8192
  # image: busybox:1.36
  securityContext:
    # Compatible with podSecurity standard privileged
    privileged: true
    # if run without root permissions, error "sysctl: permission denied on key xxx, ignoring"
    runAsUser: 0
    readOnlyRootFilesystem: true
  # resources: {}

# This should not be required anymore, used to chown/chmod folder created by faulty CSI driver that are not applying properly POSIX fsgroup.
initFs:
  enabled: true
  # Image: busybox:1.36
  # Compatible with podSecurity standard baseline.
  securityContext:
    privileged: false
    runAsNonRoot: false
    runAsUser: 0
    runAsGroup: 0
    seccompProfile:
      type: RuntimeDefault
    capabilities:
      drop: ["ALL"]
      add: ["CHOWN"]
    readOnlyRootFilesystem: true
resources:
  limits:
    cpu: 800m
    memory: 6144M
    ephemeral-storage: 512000M
  requests:
    cpu: 400m
    memory: 2048M
    ephemeral-storage: 1536M

jdbcOverwrite:
  enabled: true
  jdbcUrl: "${extra_vars.sonarqube_jdbc_url}"
  jdbcUsername: "${extra_vars.sonarqube_jdbc_user}"
  jdbcSecretName: "sonarqube-secret"
  jdbcSecretPasswordKey: "jdbc-password"

postgresql:
  enabled: false
  
serviceAccount:
  create: true
  # name:
  automountToken: true # default
  ## Annotations for the Service Account
  annotations:
    iam.gke.io/gcp-service-account: "${service_account_annotation}"

account:
  adminPasswordSecretName: "sonarqube-secret"

extraConfig:
  secrets:
    - sonarqube-secret
